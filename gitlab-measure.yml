measure:
  image: debian:stretch
  stage: measure
  before_script:
    # fix TERM
    - export TERM=dumb
    # install requirements
    - apt update && apt install -y curl jq git
    # checkout to current branch
    - git checkout -B "$CI_COMMIT_REF_NAME" "$CI_COMMIT_SHA"
    # set git user
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "Runner = $CI_RUNNER_DESCRIPTION"
    # prepare acccess token for update script
    - if [[ -z "$ACCESS_TOKEN" ]]; then echo "Undefined variable ACCESS_TOKEN"; exit 1; fi
    # install cap
    - git clone https://github.com/InternetGuru/cap
    - |
        if ! git -C cap checkout -q "$CAP_REVISION"; then
          revision="$(git -C cap tag | grep ^v$CAP_REVISION\. | sort --version-sort | tail -1)"
          git -C cap checkout "$revision"
        fi
    - chmod +x cap/measure.sh
    - curl -o moss "$CAP_MOSS"
    - chmod +x moss
  script:
    # run plagiarism check
    - ./cap/measure.sh "$ACCESS_TOKEN"
  when: manual
